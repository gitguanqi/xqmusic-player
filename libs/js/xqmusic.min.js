/* 
author: gitguanqi,
date: 2022-09-24,
version: 0.0.1
*/
function XqMusic(t={el:"body",list:[],move:!1,slide:!1,slideBottom:0}){if(this.options=t,!t.el)throw new Error("el is must!");this.version="v0.0.1",this.author="gitguanqi",this.date="2022-09-24",this.pluginName="XQMusicPlayer",this.elem=$g.dom(t.el),this.songList=this.options.list,this.currentIndex=0,this.lyricShow=!1,this.songShow=!1,this.playStatus=!1,this.initPage(t.el),this.initElem(),this.options.list&&this.options.list.length&&this.initEvents(),this.options.move&&(this.elem.firstChild.classList.add("move"),this.boxDrag()),this.songList&&this.songList.length&&(this.showList(),this.showDefault())}XqMusic.prototype.initPage=function(){let t=this.elem;if(t&&""===t.innerText){let i=document.createElement("div");i.className=this.options.slide?"xqmusic slide":"xqmusic",i.style.bottom=this.options.slideBottom||0===this.options.slideBottom?0===this.options.slideBottom?0:this.options.slideBottom+"px":"25px",i.innerHTML='<div class="xqmusic-top active">\n                <ul class="xqmusic-menu-ls scroll-box"></ul>\n                <ul class="xqmusic-lyric-ls scroll-box">\n                    <li>暂无歌词</li>\n                </ul>\n            </div>\n            <div class="xqmusic-bottom">\n                <audio id="xqmusic-audio" src=""></audio>\n                <!-- 歌曲封面图 -->\n                <div class="xqmusic-img">\n                    <div id="xqmusic-cover-img"></div>\n                </div>\n                <div class="xqmusic-main">\n                    <!-- 歌曲标题 -->\n                    <div class="xqmusic-title">\n                        <small class="overflow" id="xqmusic-song-title">歌手 - 歌曲名</small>\n                    </div>\n                    <!-- 歌曲进度条 -->\n                    <div class="xqmusic-progress">\n                        <small id="xqmusic-current">00:00</small>\n                        <span>\n                            <i id="xqmusic-progress-bar"></i>\n                        </span>\n                        <small id="xqmusic-total">00:00</small>\n                    </div>\n                    <!-- 歌曲操作按钮 -->\n                    <div class="xqmusic-btns">\n                        <button id="xqmusic-muted" title="静音">\n                            <i class="fa fa-volume-mute"></i>\n                        </button>\n                        <button id="xqmusic-volumn" class="active" title="声音">\n                            <i class="fa fa-volume-down"></i>\n                        </button>\n                        <button id="xqmusic-prev" title="上一首">\n                            <i class="fa fa-chevron-left"></i>\n                        </button>\n                        <button id="xqmusic-pause" title="暂停">\n                            <i class="fa fa-pause"></i>\n                        </button>\n                        <button id="xqmusic-play" class="active" title="播放">\n                            <i class="fa fa-play"></i>\n                        </button>\n                        <button id="xqmusic-next" title="下一首">\n                            <i class="fa fa-chevron-right"></i>\n                        </button>\n                        <button id="xqmusic-word" title="歌词">\n                            <i class="fa fa-file-word"></i>\n                        </button>\n                        <button id="xqmusic-list" title="列表">\n                            <i class="fa fa-list"></i>\n                        </button>\n                    </div>\n                </div>\n            </div>',t.appendChild(i)}return!0},XqMusic.prototype.initElem=function(){this.xqCoverImg=$g.gId("xqmusic-cover-img"),this.xqSongTitle=$g.gId("xqmusic-song-title"),this.xqProgressBar=$g.gId("xqmusic-progress-bar"),this.xqCurrentTime=$g.gId("xqmusic-current"),this.xqTotal=$g.gId("xqmusic-total"),this.xqMuted=$g.gId("xqmusic-muted"),this.xqVolumn=$g.gId("xqmusic-volumn"),this.xqPrev=$g.gId("xqmusic-prev"),this.xqPause=$g.gId("xqmusic-pause"),this.xqPlay=$g.gId("xqmusic-play"),this.xqNext=$g.gId("xqmusic-next"),this.xqWord=$g.gId("xqmusic-word"),this.xqList=$g.gId("xqmusic-list"),this.xqSongBox=$g.dom(".xqmusic-menu-ls"),this.xqLyricBox=$g.dom(".xqmusic-lyric-ls"),this.xqAudio=$g.gId("xqmusic-audio"),this.xqTop=$g.dom(".xqmusic-top")},XqMusic.prototype.initEvents=function(){this.xqWord.addEventListener("click",()=>{this.lyricPageToggle()},!1),this.xqList.addEventListener("click",()=>{this.songPageToggle()},!1),this.xqMuted.addEventListener("click",()=>{this.showMuted()},!1),this.xqVolumn.addEventListener("click",()=>{this.showVolumn()},!1),this.xqPlay.addEventListener("click",()=>{this.playSong()},!1),this.xqPause.addEventListener("click",()=>{this.playSong()},!1),this.xqAudio.addEventListener("timeupdate",()=>{this.getTime()},!1),this.xqPrev.addEventListener("click",()=>{this.togglePrevSong()},!1),this.xqNext.addEventListener("click",()=>{this.toggleNextSong()},!1)},XqMusic.prototype.boxDrag=function(){new $g.Drag($g.dom(`${this.options.el} .xqmusic`))},XqMusic.prototype.showList=function(){let t="";for(const i of this.songList)t+=`<li data-id="${i.id}">\n            <span class="overflow">${i.name}</span>\n            <button data-id="${i.id}" class="song-play">\n                <i data-id="${i.id}" class="fa fa-play"></i>\n            </button>\n        </li>`;this.xqSongBox.innerHTML=t,this.showCurrentHigh()},XqMusic.prototype.showCurrentHigh=function(){let t=document.querySelectorAll(".xqmusic-menu-ls li");for(const i of t){i.className="",i.querySelector("i").className="fa fa-play";let t=i.getAttribute("data-id");t==this.songList[this.currentIndex].id&&(i.className="active",i.querySelector("i").className=this.playStatus?"fa fa-pause":"fa fa-play"),i.querySelector("button").addEventListener("click",t=>{this.toggleListSong(t)},!1)}},XqMusic.prototype.showDefault=function(){let t=this.songList[this.currentIndex];this.xqCoverImg.style.backgroundImage=`url(${t.pic})`,this.xqAudio.src=t.url,this.xqSongTitle.innerText=`${t.author} - ${t.name}`,t.lyric_url?this.getLyric(t.lyric_url):(this.xqLyricBox.innerHTML="<li>暂无歌词</li>",localStorage.setItem("lyrcis",JSON.stringify({}))),this.showCurrentHigh()},XqMusic.prototype.getLyric=async function(t){let i=await axios.get(t),s=this.parseLyric(i.data);localStorage.setItem("lyrcis",JSON.stringify(s)),this.showLyric(s)},XqMusic.prototype.parseLyric=function(t){let i={ti:"",ar:"",al:"",by:"",offset:0,ms:[]};if(0===t.length)return;let s=t.split("\n");for(let t in s){s[t]=s[t].replace(/(^\s*)|(\s*$)/g,"");let e=s[t].substring(s[t].indexOf("[")+1,s[t].indexOf("]")),o=e.split(":");if(isNaN(parseInt(o[0])))for(const t in i)"ms"!==t&&t==o[0].toLowerCase()&&(i[t]=o[1]);else{let e=s[t].match(/\[(\d+:.+?)\]/g),o=0;for(const t in e)o+=e[t].length;let n=s[t].substring(o);for(const t in e){let s=e[t].substring(1,e[t].length-1),o=s.split(":");i.ms.push({t:(60*parseFloat(o[0])+parseFloat(o[1])).toFixed(3),c:n})}}}return i.ms.sort(function(t,i){return t.t-i.t}),i},XqMusic.prototype.showLyric=function(t){let i="";for(const s of t.ms)i+=`<li>${s.c}</li>`;this.xqLyricBox.innerHTML=i},XqMusic.prototype.lyricPageToggle=function(){this.lyricShow=!this.lyricShow,this.songShow=!1,this.xqLyricBox.style.display=this.lyricShow?"block":"none",this.xqSongBox.style.display="none",this.xqTop.className=this.lyricShow?"xqmusic-top":"xqmusic-top active"},XqMusic.prototype.songPageToggle=function(){this.songShow=!this.songShow,this.lyricShow=!1,this.xqSongBox.style.display=this.songShow?"block":"none",this.xqLyricBox.style.display="none",this.xqTop.className=this.songShow?"xqmusic-top":"xqmusic-top active"},XqMusic.prototype.showMuted=function(){this.xqMuted.className="",this.xqVolumn.className="active",this.xqAudio.muted=!1},XqMusic.prototype.showVolumn=function(){this.xqMuted.className="active",this.xqVolumn.className="",this.xqAudio.muted=!0},XqMusic.prototype.playSong=function(){this.playStatus?(this.xqAudio.pause(),this.xqPlay.classList.add("active"),this.xqPause.classList.remove("active"),this.xqCoverImg.classList.remove("active")):(this.xqAudio.play(),this.xqPlay.classList.remove("active"),this.xqPause.classList.add("active"),this.xqCoverImg.classList.add("active"),this.getTime()),this.playStatus=!this.playStatus,this.showCurrentHigh()},XqMusic.prototype.getTime=function(t){if(!this.playStatus)return;let i=this.xqAudio.currentTime||t.timeStamp/1e3;this.xqCurrentTime.innerText=this.calcTimeStr(i).m;let s=i/this.xqAudio.duration*100;this.xqProgressBar.style.width=s+"%",this.xqTotal.innerText=this.xqAudio.duration?this.calcTimeStr(this.xqAudio.duration).m:"00:00",this.songList[this.currentIndex].lyric_url&&this.showLyricPos(i)},XqMusic.prototype.calcTimeStr=function(t){let i=0,s=0,e=0,o=t%60,n="";if(t<3600)i=o,s=parseInt(t/60),e=0;else{let o=t%3600;o%60<60&&(i=o%60,s=parseInt(o/60)),s=parseInt(o/60),e=parseInt(t/3600)}return i=i>10?parseInt(i):"0"+parseInt(i),s=s>10?s:"0"+s,e=e>10?e:"0"+e,n=e+":"+s+":"+i,{h:n,m:s+":"+i}},XqMusic.prototype.showLyricPos=function(t){let i=localStorage.getItem("lyrcis"),s=document.querySelectorAll(".xqmusic-lyric-ls li");if(i=JSON.parse(i).ms,i&&0===i.length)return;let e=0;for(let o=0;o<i.length;o++){let n=i[o],l=t-n.t;if(l>=0&&l<1){e=o;for(const t of s)t.className="";s[o].className="active";let t=s[o].offsetTop,i=this.xqLyricBox.offsetHeight/2,n=i/36,l=t-i;this.xqLyricBox.scrollTop=o>=n&&l>0?l:0}}},XqMusic.prototype.togglePrevSong=function(){0===this.currentIndex&&(this.currentIndex=this.songList.length),this.currentIndex--,this.toggleMusic(this.currentIndex)},XqMusic.prototype.toggleNextSong=function(){this.currentIndex>=0&&this.currentIndex<=this.songList.length&&this.currentIndex++,this.currentIndex==this.songList.length&&(this.currentIndex=0),this.toggleMusic()},XqMusic.prototype.toggleListSong=function(t){let i=t.target.dataset.id,s=this.songList.findIndex(t=>i==t.id);this.currentIndex=s,this.toggleMusic()},XqMusic.prototype.toggleMusic=function(){this.showDefault(),this.showCurrentHigh(),this.xqCoverImg.className="",this.xqTotal.innerText="00:00",this.xqLyricBox.scrollTop=0,this.xqAudio.pause(),this.xqPlay.classList.add("active"),this.xqPause.classList.remove("active"),this.xqCoverImg.classList.remove("active"),this.playStatus=!1};